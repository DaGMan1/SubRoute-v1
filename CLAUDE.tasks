# SubRoute - Claude Tasks & Source of Truth
# Last Updated: 2026-01-30

================================================================================
## PROJECT OVERVIEW
================================================================================

SubRoute is a courier logistics app for Australian delivery drivers.
Primary purpose: Track trips for ATO tax deductions with accurate distance logging.

**Target User:** Courier/delivery drivers in Australia
**Primary Device:** Mobile phone (iOS/Android browser)
**Key Requirement:** ATO-compliant trip logging for tax deductions

================================================================================
## TECH STACK
================================================================================

### Frontend
- **Framework:** React 18 with TypeScript
- **Build Tool:** Vite
- **Styling:** Tailwind CSS
- **Maps:** Google Maps JavaScript API
- **Places:** Google Places Autocomplete API
- **Directions:** Google Directions API (for distance calculation)

### Backend / Database
- **Authentication:** Firebase Authentication (Google Sign-In)
- **Database:** Firebase Firestore (NoSQL)
- **Hosting:** Vercel (auto-deploys from GitHub main branch)

### External Services
- **Google Maps JavaScript API** - Map display, markers, routes
- **Google Places API** - Address autocomplete/search
- **Google Directions API** - Route distance calculation
- **Google/Waze Apps** - External navigation (opened via URL schemes)

### Configuration Files
- `vite.config.ts` - Vite build configuration
- `tsconfig.json` - TypeScript configuration
- `tailwind.config.js` - Tailwind CSS configuration
- `vercel.json` - Vercel deployment settings
- `package.json` - Dependencies and scripts
- `index.html` - Entry HTML with Google Maps script tag

### API Keys
- **Google Maps API Key:** Stored in index.html
  - Key: AIzaSyAkTPhW5UOilg5YFsXEj0rY-e3cLTTN1xI
  - Must have these APIs enabled in Google Cloud Console:
    - Maps JavaScript API
    - Places API
    - Directions API
- **Firebase Config:** Stored in lib/firebase.ts

================================================================================
## PROJECT STRUCTURE
================================================================================

```
/SubRoute-github/
├── components/
│   ├── SimpleRoutePlanner.tsx   # Main route planning UI (79KB)
│   ├── TripLogbook.tsx          # Trip history views (30KB)
│   ├── Settings.tsx             # User preferences (13KB)
│   ├── Auth.tsx                 # Firebase authentication
│   ├── Dashboard.tsx            # Main navigation hub
│   ├── VehicleManager.tsx       # Vehicle CRUD operations
│   └── OdometerTracker.tsx      # Odometer/fuel tracking
├── lib/
│   ├── firebase.ts              # Firebase initialization
│   ├── firestore.ts             # All Firestore operations
│   ├── config.ts                # App configuration
│   └── utils.ts                 # Helper functions
├── App.tsx                      # Root component with routing
├── types.ts                     # TypeScript interfaces
├── index.html                   # Entry HTML + Google Maps API
├── index.tsx                    # React entry point
├── CLAUDE.tasks                 # This file
└── package.json                 # Dependencies
```

================================================================================
## DATA MODELS (Firestore)
================================================================================

### User Preferences
Path: `users/{userId}/preferences/main`
```typescript
interface UserPreferences {
  depotAddress?: string;           // JSON stringified {address, location}
  currentOdometer?: number;        // Current vehicle odometer reading
  preferredNavApp?: 'google' | 'waze';  // Navigation app preference
}
```

### Vehicles
Path: `users/{userId}/vehicles/{vehicleId}`
```typescript
interface Vehicle {
  id: string;
  make: string;
  model: string;
  year: number;
  plate: string;
  isDefault: boolean;
}
```

### Trip Logs
Path: `users/{userId}/tripLogs/{tripId}`
```typescript
interface TripLog {
  id: string;
  timestamp: number;
  date: string;              // "YYYY-MM-DD"
  startTime: string;         // "HH:MM"
  endTime: string;           // "HH:MM"
  origin: string;            // Address string
  destination: string;       // Address string
  distanceKm: number;        // Calculated via Google Directions API
  vehicleString: string;     // "Make Model (Plate)"
  durationMinutes: number;
}
```

### Address History
Path: `users/{userId}/addressHistory/{addressId}`
```typescript
interface SavedAddress {
  id: string;
  address: string;
  location: { lat: number; lng: number };
  lastUsed: number;
  useCount: number;
}
```

### Favorite Addresses
Path: `users/{userId}/favorites/{favoriteId}`
```typescript
interface FavoriteAddress {
  id: string;
  name: string;              // User-defined nickname
  address: string;
  location: { lat: number; lng: number };
  createdAt: number;
}
```

================================================================================
## INFORMATION FLOW
================================================================================

### 1. User Authentication Flow
```
User opens app
    ↓
Auth.tsx checks Firebase auth state
    ↓
If not logged in → Show Google Sign-In button
    ↓
User clicks Sign In → Firebase Google OAuth
    ↓
Firebase returns user object
    ↓
App.tsx sets user state → Dashboard renders
```

### 2. Route Planning Flow (Streamlined - 3 clicks)
```
User types/speaks address in search box
    ↓
Google Places Autocomplete shows suggestions (debounced 300ms)
    ↓
User taps address from dropdown
    ↓
pendingStop state set with address + location
    ↓
Modal appears: "Pickup" or "Delivery" buttons
    ↓
User taps Pickup/Delivery
    ↓
addStopAndNavigate() executes:
    1. Creates Stop object {id, address, location, type}
    2. Adds stop to stops[] array
    3. Clears pendingStop state
    4. Calls startNavigationToStop(stop, preferredNavApp)
    ↓
startNavigationToStop() executes:
    1. Checks if activeTrip exists → calls logCompletedTrip() first
    2. Determines origin (lastGpsPosition || currentLocation || null)
    3. Creates newTrip object:
       - origin: last destination address or depot or "Current Location"
       - originLocation: GPS coordinates
       - destination: stop.address
       - destinationLocation: stop.location
       - startTime: Date.now()
    4. Sets activeTrip state
    5. Opens navigation app:
       - Google: window.location.href = "https://www.google.com/maps/dir/?api=1&destination=..."
       - Waze: window.location.href = "https://waze.com/ul?ll=...&navigate=yes"
    ↓
User navigates using external app (Google Maps/Waze)
    ↓
User returns to SubRoute app
    ↓
Stop shows "Mark as Done" button (purple, EN ROUTE badge)
    ↓
User taps "Mark as Done"
    ↓
manualCompleteStop() → logCompletedTrip()
```

### 3. Trip Logging Flow (logCompletedTrip)
```
logCompletedTrip() called
    ↓
Mutex check: if isLoggingTrip.current === true → return (prevent duplicates)
    ↓
Set mutex: isLoggingTrip.current = true
    ↓
Capture activeTrip data into tripToLog
    ↓
Calculate duration: (endTime - startTime) / 60000 → minutes
    ↓
Clear activeTrip state immediately
    ↓
getRouteDistance(origin, destination):
    ↓
    directionsService.route({
      origin: tripToLog.originLocation,
      destination: tripToLog.destinationLocation,
      travelMode: DRIVING
    })
    ↓
    Returns: result.routes[0].legs[0].distance.value / 1000 → km
    ↓
    If API fails → Fallback: haversine distance * 1.3
    ↓
getVehicles(userId) → Find default vehicle
    ↓
Create TripLog object:
    {
      id: timestamp string,
      timestamp: endTime,
      date: "YYYY-MM-DD",
      startTime: "HH:MM",
      endTime: "HH:MM",
      origin: address string,
      destination: address string,
      distanceKm: from Google Directions,
      vehicleString: "Make Model (Plate)",
      durationMinutes: calculated
    }
    ↓
saveTripLog(userId, tripLog) → Firestore write
    ↓
Mark stop as completed: completedStops.add(stopId)
    ↓
Update refs for next trip:
    - lastGpsPosition.current = destinationLocation
    - lastDestinationAddress.current = destination
    ↓
Release mutex: isLoggingTrip.current = false
```

### 4. Trip Log Display Flow
```
TripLogbook.tsx mounts
    ↓
subscribeToTripLogs(userId, callback):
    - Creates Firestore real-time listener
    - Query: tripLogs collection, orderBy timestamp desc
    ↓
Firestore pushes TripLog[] to callback
    ↓
setLogs(trips) → Component re-renders
    ↓
getDailySummaries(): Groups logs by date
    - Calculates: totalDistance, totalTrips, firstTripTime, lastTripTime
    ↓
User selects view via hamburger menu:
    ├─ "Today's Summary" → TodaySummaryView
    │   - Big stat cards (distance, trips, time, avg speed, avg/trip)
    │   - Today's trip list
    ├─ "Daily History" → DailySummaryView
    │   - Cards per day with expandable trip list
    ├─ "Weekly Summary" → WeeklySummaryView
    │   - Grouped by Mon-Sun weeks
    ├─ "Monthly Summary" → MonthlySummaryView
    │   - Grouped by month with averages
    └─ "All Trips" → IndividualTripsView
        - Full detail per trip
```

### 5. CSV Export Flow
```
User taps Export button in TripLogbook
    ↓
exportToCSV() executes:
    ↓
getUserPreferences(userId) → Get currentOdometer (starting point)
    ↓
Sort logs by timestamp ascending (oldest first)
    ↓
For each trip in sortedLogs:
    startOdo = currentOdometer
    endOdo = currentOdometer + trip.distanceKm
    currentOdometer = endOdo (cumulative)

    Create CSV row:
    [date, startTime, endTime, startOdo, endOdo,
     distance, "origin", "destination",
     "Business - Courier Delivery", vehicleString]
    ↓
Join all rows with newlines
    ↓
Create Blob with CSV content
    ↓
Create download link, trigger click
    ↓
File downloads: SubRoute_Logbook_YYYY-MM-DD.csv
```

================================================================================
## KEY FUNCTIONS REFERENCE
================================================================================

### SimpleRoutePlanner.tsx

| Function | Purpose |
|----------|---------|
| `addStopAndNavigate(address, location, type)` | Add stop + auto-open nav app |
| `startNavigationToStop(stop, navApp)` | Open Google Maps/Waze URL |
| `logCompletedTrip()` | Save trip to Firestore with Google distance |
| `getRouteDistance(origin, dest)` | Call Google Directions API |
| `manualCompleteStop(stop)` | User manually completes a trip |
| `loadUserPrefs()` | Load depot address + nav preference from Firestore |
| `initMap()` | Initialize Google Map with markers |
| `calculateDistance(a, b)` | Haversine formula for straight-line distance |

### lib/firestore.ts

| Function | Purpose |
|----------|---------|
| `saveTripLog(userId, tripLog)` | Save trip to Firestore |
| `subscribeToTripLogs(userId, callback)` | Real-time trip listener |
| `clearAllTripLogs(userId)` | Delete all trips (settings only) |
| `getUserPreferences(userId)` | Get user settings |
| `saveUserPreferences(userId, prefs)` | Save user settings |
| `getVehicles(userId)` | Get user's vehicles |
| `saveVehicle(userId, vehicle)` | Save/update vehicle |
| `getAddressHistory(userId, limit)` | Get recent addresses |
| `saveAddressToHistory(userId, address)` | Save address for history |
| `getFavoriteAddresses(userId)` | Get favorite addresses |
| `saveFavoriteAddress(userId, fav)` | Save favorite |
| `deleteFavoriteAddress(userId, favId)` | Delete favorite |

================================================================================
## WORKING DIRECTORY
================================================================================

**ONLY USE THIS FOLDER:**
```
/Users/garrymans/Documents/App Dev/SubRoute-github/
```

- Git remote: git@github.com-subroute:DaGMan1/SubRoute-v1.git (SSH)
- Auto-deploys to Vercel on push to main branch
- Firebase project: subroute-eda91

**DELETED (do not recreate):**
- /Users/garrymans/Documents/App Dev/subroute/ (was sandbox code)

================================================================================
## RECENT FIXES (2026-01-30)
================================================================================

### 1. Missing First Trips of the Day - FIXED
- **Problem:** `startNavigationToStop()` set `activeTrip` via React state then immediately did `window.location.href` to open nav app. React effect never persisted to localStorage before page navigated away. Trip state lost on return.
- **Solution:** Added `persistRouteStateSync()` helper that writes to localStorage synchronously (not via React effect) before `window.location.href`. Also persists updated stops array on `addStopAndNavigate`.

### 2. Can't Add New Address While En Route - FIXED
- **Problem:** `startNavigationToStop()` used `await logCompletedTrip()` blocking the entire flow if Directions API or Firestore was slow/failing.
- **Solution:** Changed to fire-and-forget `logCompletedTrip()` (no await). Function changed from `async` to synchronous. New navigation opens immediately while previous trip logs in background.

### 3. Can't Re-Navigate to Completed Stop - FIXED
- **Problem:** Completed stops only showed "TRIP LOGGED" badge with no way to navigate back.
- **Solution:** Added "Go Again" button (blue) on all completed stops that calls `startNavigationToStop(stop, preferredNavApp)` creating a new trip.

### 4. Fuel Stop Firebase Error Loses Data - FIXED
- **Problem:** Generic error handling, no loading state, no vehicle ID validation. Error alert was unhelpful.
- **Solution:** Added `fuelStopSaving` loading state to prevent double-taps, vehicle ID validation check, actual error message in alert, and explicit "your data has been kept" message. Form data preserved on error.

================================================================================
## PREVIOUS FIXES (2026-01-26)
================================================================================

### 1. Navigation Not Opening - FIXED
- **Problem:** `startNavigationToStop()` blocked if `currentLocation` was null
- **Solution:** Removed blocking check, use `window.location.href` not `window.open`

### 2. Trip Distance Wrong (0km or 1km) - FIXED
- **Problem:** Used GPS tracking which fails when app is backgrounded
- **Solution:** Added `getRouteDistance()` using Google Directions API

### 3. Folder Confusion - FIXED
- **Problem:** Two folders with different code pointing to same repo
- **Solution:** Deleted sandbox folder, using only SubRoute-github

================================================================================
## TESTING CHECKLIST
================================================================================

- [ ] Cold start - address search works immediately
- [ ] Voice input - recognizes addresses
- [ ] Tap Pickup/Delivery - navigation app opens
- [ ] Complete trip via "Mark as Done" - logs with correct distance
- [ ] TripLog shows trips with correct distance (not 0 or 1km)
- [ ] Export CSV - has all ATO fields
- [ ] Settings - navigation preference persists after reload

================================================================================
## ATO COMPLIANCE STATUS
================================================================================

Required fields for ATO logbook:
- [x] Date of trip
- [x] Start time and end time
- [x] Origin address
- [x] Destination address
- [x] Distance traveled (km) - using Google Directions API
- [x] Vehicle details
- [x] Purpose (hardcoded: "Business - Courier Delivery")
- [ ] Start/End odometer (currently calculated from distance, not actual readings)

================================================================================
## KNOWN LIMITATIONS
================================================================================

1. No offline support - requires internet connection
2. Google Directions API has usage limits (2,500 free requests/day)
3. Manual "Mark as Done" required - GPS auto-arrival detection unreliable
4. Odometer readings are calculated, not actual values
5. No business/personal trip toggle (all trips marked as business)

================================================================================
## FUTURE IMPROVEMENTS
================================================================================

1. Manual trip entry (for trips where app wasn't open)
2. Actual odometer reading prompts at start/end of day
3. Offline mode with background sync
4. Business/personal trip purpose toggle
5. Trip editing/deletion from TripLog
6. Integration with accounting software
7. Multi-vehicle support per trip
